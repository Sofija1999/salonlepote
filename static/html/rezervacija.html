<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervacija termina - Salon TRAC</title>
    <link rel="stylesheet" href="../css/styles_rezervacija.css">
</head>
<body>
    <h1>Rezervacija termina</h1>
    <h2>Podaci o kupcu</h2>
    <form>
        <label for="ime">Ime:</label>
        <input type="text" id="ime" name="ime" required>

        <label for="prezime">Prezime:</label>
        <input type="text" id="prezime" name="prezime" required>

        <label for="kompanija">Kompanija:</label>
        <input type="text" id="kompanija" name="kompanija">

        <label for="adresa1">Adresa 1:</label>
        <input type="text" id="adresa1" name="adresa1" required>

        <label for="adresa2">Adresa 2:</label>
        <input type="text" id="adresa2" name="adresa2">

        <label for="postanskiBroj">Poštanski broj:</label>
        <input type="text" id="postanskiBroj" name="postanskiBroj" required>

        <label for="mesto">Mesto:</label>
        <input type="text" id="mesto" name="mesto" required>

        <label for="drzava">Država:</label>
        <input type="text" id="drzava" name="drzava" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="potvrdaEmaila">Potvrda emaila:</label>
        <input type="email" id="potvrdaEmaila" name="potvrdaEmaila" required>

        <label for="termin">Izaberite termin:</label>
        <input type="datetime-local" id="termin" name="termin" required>

        <label for="promokod">PromoKod:</label>
        <input type="promokod" id="promokod" name="promokod">

        <h2>Ukupna cena: <span id="ukupnaCena">0</span> dinara</h2>

        <h3>Usluge:</h3>
        <div id="usluge-container">
            <input id="brUsluge" type="hidden" value="1" />
            <div class="usluga-row">
                <label for="usluga-select-1">Usluga 1:</label>
                <select id="usluga-select-1" class="usluga-select" onchange="updateCena(this.id )">
                    <option value="0" data-cena="0">Izaberite uslugu</option>
                    <option value="450" data-cena="450">Sisanje kratke kose</option>
                    <option value="600" data-cena="600">Sisanje srednje kose</option>
                    <option value="800" data-cena="800">Sisanje duge kose</option>
                    <option value="1500" data-cena="1500">Manikir</option>
                    <option value="2000" data-cena="2000">Pedikir</option>
                    <option value="2500" data-cena="2500">Masaza sportska</option>
                    <option value="3000" data-cena="3000">Masaza relax</option>
                </select>
                <span class="cena-span">Cena: <span class="prikazanaCena-1">0</span> dinara</span> 
            </div>
        </div>
        <button type="button" onclick="dodajUslugu()">Dodaj uslugu</button>
        <button onclick="submitReservation()">Potvrdi rezervaciju</button>
    </form>


    
    <form id="otkazForma">
        <section id="otkaziRezervaciju">
            <h2>Otkazivanje rezervacije</h2>
            <p>Ukoliko želite da otkazete rezervaciju, molimo vas unesite token rezervacije i vaš e-mail.</p>
            
                <label for="token">Token rezervacije:</label>
                <input type="text" id="token" name="token" required>

                <label for="emailOtkaz">Vaš e-mail:</label>
                <input type="email" id="emailOtkaz" name="email" required>

                <button type="submit">Otkaži rezervaciju</button>

            <div id="rezultatPoruka"></div>
        </section>
    </form>

<form id="pretragaForma">        
    <h2>Izmeni rezervaciju</h2>
    <p>Ukoliko želite da izmenite rezervaciju, molimo vas unesite token rezervacije i vaš e-mail.</p>

    <label for="pretragaToken">Unesite token rezervacije:</label>
    <input type="text" id="pretragaToken" name="token" required>

    <label for="pretragaEmail">Unesite email:</label>
    <input type="email" id="pretragaEmail" name="email" required>

    <button type="button" onclick="pretraziRezervacije()">Pretraga</button>
    <div id="rezervacijeContainer">

</form>
    <!-- Ovde će se prikazivati rezultati pretrage -->
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script>
            $('#otkazForma').submit(function (e) {
                e.preventDefault();
                let formData = $(this).serializeArray();
                console.log(formData)
                 let jsonData = {};
                 console.log(jsonData)

            $.each(formData, function(i, v) {
                jsonData[v.name] = v.value;
            });
            console.log(jsonData)
    
                $.ajax({
                    type: "DELETE",
                    url: "http://localhost:8080/api/deletereservation",
                    data: JSON.stringify(jsonData), 
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data, text) {
                        console.log(data)
                    },
                    error: function (request, status, error) {
                        console.log(request.responseText);
                    }
                });
            });

            // selectId is id of select tag
            function updateCena(selectId) {
                let brUsluge = selectId.split('-')[2];
                console.log(brUsluge);

                let selectedCena = $(`#${selectId}`).val();
                console.log(selectedCena)

                $(`.prikazanaCena-${brUsluge}`).html(selectedCena);

                // Nakon dodavanja, ažurirajte ukupnu cenu
                azurirajUkupnuCenu();
            }

            function dodajUslugu() {
                let brojUsluga = $("#brUsluge").val(); // find by element id and get its value
                brojUsluga++;

                let novaUsluga = `<div class="usluga-row">
                                <label for="usluga-select-${brojUsluga}">Usluga ${brojUsluga}:</label>
                                <select id="usluga-select-${brojUsluga}" class="usluga-select" onchange="updateCena(this.id)">
                                    <option value="0" data-cena="0">Izaberite uslugu</option>
                                    <option value="450" data-cena="450">Sisanje kratke kose</option>
                                    <option value="600" data-cena="600">Sisanje srednje kose</option>
                                    <option value="800" data-cena="800">Sisanje duge kose</option>
                                    <option value="1500" data-cena="1500">Manikir</option>
                                    <option value="2000" data-cena="2000">Pedikir</option>
                                    <option value="2500" data-cena="2500">Masaza sportska</option>
                                    <option value="3000" data-cena="3000">Masaza relax</option>
                                </select>
                                <span class="cena-span">Cena: <span class="prikazanaCena-${brojUsluga}">0</span> dinara</span> 
                            </div>`;

                $("#usluge-container").append(novaUsluga); // append to element with id="usluge-container"
                $("#brUsluge").val(brojUsluga); // new value for input hidden with id="brUsluge"

                
            }

// function dodajUslugu() {
//     let brojUsluga = 1; // Deklaracija broja usluga unutar funkcije

//     const uslugeContainer = document.getElementById('usluge-container');
            
//             const novaUslugaDiv = document.createElement('div');
//             novaUslugaDiv.classList.add('usluga-row');
//             novaUslugaDiv.id = `usluga-${brojUsluga}`;
            
//             novaUslugaDiv.innerHTML = `
//                 <label for="usluga-select-${brojUsluga}">Usluga ${brojUsluga + 1}:</label>
//                 <select id="usluga-select-${brojUsluga}" class="usluga-select" onchange="updateCena(this)">
//                     <option value="0" data-cena="0">Izaberite uslugu</option>
//                     <option value="450" data-cena="450">Sisanje kratke kose</option>
//                     <option value="600" data-cena="600">Sisanje srednje kose</option>
//                     <option value="800" data-cena="800">Sisanje duge kose</option>
//                     <option value="1500" data-cena="1500">Manikir</option>
//                     <option value="2000" data-cena="2000">Pedikir</option>
//                     <option value="2500" data-cena="2500">Masaza sportska</option>
//                     <option value="3000" data-cena="3000">Masaza relax</option>
//                 </select>
//                 <span class="cena-span">Cena: <span class="prikazanaCena-${brojUsluga}">0</span> dinara</span>
//             `;
            
//             uslugeContainer.appendChild(novaUslugaDiv);
//             updateCena(document.getElementById(`usluga-select-${brojUsluga}`));
            
//             brojUsluga++; // Povećaj broj usluga za buduće ID vrednosti
//         }

        function pretraziRezervacije() {
            const token = $('#pretragaToken').val();
            const email = $('#pretragaEmail').val();

            fetch(`http://localhost:8080/api/reservation?token=${token}&email=${email}`)
            .then(response => response.json())
            .then(data => {
                const rezervacijeContainer = document.getElementById('rezervacijeContainer');
                let rezultatHtml = '';

                // Prikazujemo broj rezervacije i ukupnu cenu
                rezultatHtml += `<p>Broj rezervacije: ${data.id}</p>`;
                rezultatHtml += `<p>Ukupna cena: ${data.ukupna_cena} dinara</p>`;

                // Kreiramo tabelu za prikaz usluga
                rezultatHtml += '<table>';
                rezultatHtml += '<tr><th>Usluga ID</th><th>Naziv usluge</th><th>Cena usluge</th></tr>';

                // Iteriramo kroz usluge rezervacije i dodajemo ih u tabelu
                data.stavke_rezervacije.forEach((usluga) => {
                    rezultatHtml += `<tr>`;
                    rezultatHtml += `<td>${usluga.id}</td>`;
                    rezultatHtml += `<td>${usluga.usluga_naziv}</td>`;
                    rezultatHtml += `<td>${usluga.cena} dinara</td>`;
                    rezultatHtml += `</tr>`;
                });

                rezultatHtml += '</table>';

                // Postavljamo generisani HTML u container
                rezervacijeContainer.innerHTML = rezultatHtml;
            })
            .catch(error => {
                console.error('Došlo je do greške pri pretrazi rezervacija:', error);
                // Ovde možete prikazati neku poruku o grešci korisniku
            });
        }

        // Funkcija za ažuriranje ukupne cene
        function azurirajUkupnuCenu() {
            ukupnaCena = 0;
            $(".usluga-select").each(function() {
        let cena = parseInt($(this).find(":selected").data("cena"));
        ukupnaCena += cena;
            });
        $("#ukupnaCena").text(ukupnaCena);
        }

        // Povežite funkciju sa promenama u selektovanim uslugama
        $(".usluga-select").change(function() {
            azurirajUkupnuCenu();
        });

    </script>
</body>
</html>

    </script>
    
</body>
</html>