<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezervacija termina - Salon TRAC</title>
    <link rel="stylesheet" href="../css/styles_rezervacija.css">
</head>
<body>
    <h1>Rezervacija termina</h1>
    <h2>Podaci o kupcu</h2>
    <form id="reservation_form">
        <label for="ime">Ime:</label>
        <input type="text" id="ime" required class="required-input" required>

        <label for="prezime">Prezime:</label>
        <input type="text" id="prezime" name="prezime" required>

        <label for="kompanija">Kompanija:</label>
        <input type="text" id="kompanija" name="kompanija">

        <label for="adresa1">Adresa 1:</label>
        <input type="text" id="adresa1" name="adresa1" required>

        <label for="adresa2">Adresa 2:</label>
        <input type="text" id="adresa2" name="adresa2">

        <label for="postanskiBroj">Poštanski broj:</label>
        <input type="text" id="postanskiBroj" name="postanskiBroj" required>

        <label for="mesto">Mesto:</label>
        <input type="text" id="mesto" name="mesto" required>

        <label for="drzava">Država:</label>
        <input type="text" id="drzava" name="drzava" required>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <label for="potvrdaEmaila">Potvrda emaila:</label>
        <input type="email" id="potvrdaEmaila" name="potvrdaEmaila" required>

        <label for="termin">Izaberite termin:</label>
        <input type="datetime-local" id="termin" name="termin" required>

        <label for="promokod">PromoKod:</label>
        <input type="promokod" id="promokod" name="promokod">

        <h2>Ukupna cena: <span id="ukupnaCena">0</span> dinara</h2>

        <h3>Usluge:</h3>
        <div id="usluge-container">
            <input id="brUsluge" type="hidden" value="1" />
            <div class="usluga-row">
                <label for="usluga-select-1">Usluga 1:</label>
                <select id="usluga-select-1" class="usluga-select" onchange="updateCena(this.id )">
                    <option value="0" data-cena="0" >Izaberite uslugu</option>
                    <option value="450" data-cena="450" >Sisanje kratke kose</option>
                    <option value="600" data-cena="600" >Sisanje srednje kose</option>
                    <option value="800" data-cena="800" >Sisanje duge kose</option>
                    <option value="1500" data-cena="1500" >Manikir</option>
                    <option value="2000" data-cena="2000" >Pedikir</option>
                    <option value="2500" data-cena="2500" >Masaza sportska</option>
                    <option value="3000" data-cena="3000" >Masaza relax</option>
                </select>
                <span class="cena-span">Cena: <span class="prikazanaCena-1">0</span> dinara</span> 
            </div>
        </div>
        <button type="button" onclick="dodajUslugu()">Dodaj uslugu</button>
        <input type="submit" value="Rezerviši">


    </form>


    
    <form id="otkazForma">
        <section id="otkaziRezervaciju">
            <h2>Otkazivanje rezervacije</h2>
            <p>Ukoliko želite da otkazete rezervaciju, molimo vas unesite token rezervacije i vaš e-mail.</p>
            
                <label for="token">Token rezervacije:</label>
                <input type="text" id="token" name="token" required>

                <label for="emailOtkaz">Vaš e-mail:</label>
                <input type="email" id="emailOtkaz" name="email" required>

                <button type="submit">Otkaži rezervaciju</button>

            <div id="rezultatPoruka"></div>
        </section>
    </form>

<form id="pretragaForma">        
    <h2>Izmeni rezervaciju</h2>
    <p>Ukoliko želite da izmenite rezervaciju, molimo vas unesite token rezervacije i vaš e-mail.</p>

    <label for="pretragaToken">Unesite token rezervacije:</label>
    <input type="text" id="pretragaToken" name="token" required>

    <label for="pretragaEmail">Unesite email:</label>
    <input type="email" id="pretragaEmail" name="email" required>

    <button type="button" onclick="pretraziRezervacije()">Pretraga</button>
    <div id="rezervacijeContainer">

</form>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script>
            $('#otkazForma').submit(function (e) {
                e.preventDefault();
                let formData = $(this).serializeArray();
                console.log(formData)
                 let jsonData = {};
                 console.log(jsonData)

            $.each(formData, function(i, v) {
                jsonData[v.name] = v.value;
            });
            console.log(jsonData)
    
                $.ajax({
                    type: "DELETE",
                    url: "http://localhost:8080/api/deletereservation",
                    data: JSON.stringify(jsonData), 
                    dataType: "json",
                    contentType: "application/json",
                    success: function (data, text) {
                        console.log(data)
                    },
                    error: function (request, status, error) {
                        console.log(request.responseText);
                    }
                });
            });

            // selectId is id of select tag
            function updateCena(selectId) {
                let brUsluge = selectId.split('-')[2];
                console.log(brUsluge);

                let selectedCena = $(`#${selectId}`).val();
                console.log(selectedCena)

                $(`.prikazanaCena-${brUsluge}`).html(selectedCena);

                // Nakon dodavanja, ažurirajte ukupnu cenu
                azurirajUkupnuCenu();
            }


            function dodajUslugu() {
                let brojUsluga = $("#brUsluge").val(); // find by element id and get its value
                brojUsluga++;

                let novaUsluga = `<div class="usluga-row">
                                <label for="usluga-select-${brojUsluga}">Usluga ${brojUsluga}:</label>
                                <select id="usluga-select-${brojUsluga}" class="usluga-select" onchange="updateCena(this.id)">
                                    <option value="0" data-cena="0">Izaberite uslugu</option>
                                    <option value="450" data-cena="450">Sisanje kratke kose</option>
                                    <option value="600" data-cena="600">Sisanje srednje kose</option>
                                    <option value="800" data-cena="800">Sisanje duge kose</option>
                                    <option value="1500" data-cena="1500">Manikir</option>
                                    <option value="2000" data-cena="2000">Pedikir</option>
                                    <option value="2500" data-cena="2500">Masaza sportska</option>
                                    <option value="3000" data-cena="3000">Masaza relax</option>
                                </select>
                                <span class="cena-span">Cena: <span class="prikazanaCena-${brojUsluga}">0</span> dinara</span> 
                            </div>`;

                $("#usluge-container").append(novaUsluga); // append to element with id="usluge-container"
                $("#brUsluge").val(brojUsluga); // new value for input hidden with id="brUsluge"

                
            }


        function pretraziRezervacije() {
            const token = $('#pretragaToken').val();
            const email = $('#pretragaEmail').val();

            fetch(`http://localhost:8080/api/reservation?token=${token}&email=${email}`)
            .then(response => response.json())
            .then(data => {
                const rezervacijeContainer = document.getElementById('rezervacijeContainer');
                let rezultatHtml = '';

                // Prikazujemo broj rezervacije i ukupnu cenu
                rezultatHtml += `<p>Broj rezervacije: ${data.id}</p>`;
                rezultatHtml += `<p>Ukupna cena: ${data.ukupna_cena} dinara</p>`;

                // Kreiramo tabelu za prikaz usluga
                rezultatHtml += '<table>';
                rezultatHtml += '<tr><th>Usluga ID</th><th>Naziv usluge</th><th>Cena usluge</th></tr>';

                // Iteriramo kroz usluge rezervacije i dodajemo ih u tabelu
                data.stavke_rezervacije.forEach((usluga) => {
                    rezultatHtml += `<tr>`;
                    rezultatHtml += `<td>${usluga.id}</td>`;
                    rezultatHtml += `<td>${usluga.usluga_naziv}</td>`;
                    rezultatHtml += `<td>${usluga.cena} dinara</td>`;
                     // Dodajemo dugme za brisanje sa odgovarajućim atributima za identifikaciju usluge
                     rezultatHtml += `<td><button class="btn-delete-stavka" data-usluga-id="${usluga.id}">Obriši</button></td>`;
                    rezultatHtml += `</tr>`;
                });

                rezultatHtml += '</table>';

                // Postavljamo generisani HTML u container
                rezervacijeContainer.innerHTML = rezultatHtml;
            })
            .catch(error => {
                console.error('Došlo je do greške pri pretrazi rezervacija:', error);
                // Ovde možete prikazati neku poruku o grešci korisniku
            });
        }

        // Dodajte event listener na body (ili na odgovarajući roditeljski element)
        document.body.addEventListener('click', function (event) {
        if (event.target.classList.contains('obrisi-uslugu')) {
        const uslugaId = event.target.dataset.uslugaId;
        obrisiUslugu(uslugaId); // Poziv funkcije za brisanje usluge
        }
        });

        $(document).on('click', '.btn-delete-stavka', function(event) {
        event.preventDefault(); // Sprečava podrazumevano ponašanje dugmeta
        const uslugaId = $(this).data('usluga-id');

        $.ajax({
        type: "DELETE",
        url: `http://localhost:8080/api/deletestavka/${uslugaId}`,
        dataType: "json",
        contentType: "application/json",
        success: function(data, text) {
            console.log(data);
            // Osvježite prikaz ili pretragu rezervacija nakon brisanja stavke
        },
        error: function(request, status, error) {
            alert(request.responseText);
        }
    });
});

        // Funkcija za ažuriranje ukupne cene
        function azurirajUkupnuCenu() {
            ukupnaCena = 0;
            $(".usluga-select").each(function() {
        let cena = parseInt($(this).find(":selected").data("cena"));
        ukupnaCena += cena;
            });
        $("#ukupnaCena").text(ukupnaCena);
        }

        //povezivanje funkcije sa promenama u uslugama
        $(".usluga-select").change(function() {
            azurirajUkupnuCenu();
        });


        $('#reservation_form').submit(function (e) {
            e.preventDefault()

    // Sakupljanje podataka sa forme
    var ime = document.getElementById("ime").value;
    var prezime = document.getElementById("prezime").value;
    var kompanija = document.getElementById("kompanija").value;
    var adresa1 = document.getElementById("adresa1").value;
    var adresa2 = document.getElementById("adresa2").value;
    var postanskiBroj = document.getElementById("postanskiBroj").value;
    var mesto = document.getElementById("mesto").value;
    var drzava = document.getElementById("drzava").value;
    var email = document.getElementById("email").value;
    var potvrdaEmaila = document.getElementById("potvrdaEmaila").value;
    var termin = document.getElementById("termin").value;
    var promokod = document.getElementById("promokod").val

     //provera da li su sva polja koja su obavezna popunjena
     if (!ime || !prezime || !adresa1 || !postanskiBroj || !mesto || !drzava || !email || !potvrdaEmaila || !termin) {
        alert("Molimo vas da popunite sva obavezna polja.");
        return; 
    }

    //provera da li se polja email i potvrdaEmaila podudaraju
    if (email !== potvrdaEmaila) {
        alert("Polja za email i potvrdu emaila se ne podudaraju.");
        return; 
    }

    //provera za vreme, da li je termin u radnom vremenu od 9-18
    var terminDate = new Date(termin);
    //postavljanje vremena za početak i kraj radnog vremena (9 ujutru i 6 uveče)
    var pocetakRadnogVremena = new Date(terminDate);
    pocetakRadnogVremena.setHours(9, 0, 0, 0);
    var krajRadnogVremena = new Date(terminDate);
    krajRadnogVremena.setHours(18, 0, 0, 0);

    // Provera da li je termin u dobrom opsegu
    if (terminDate >= pocetakRadnogVremena && terminDate <= krajRadnogVremena) {
    // Termin je unutar radnog vremena
    console.log("Termin je u dobrom opsegu.");
    } else {
    // Termin nije u radnom vremenu
    console.log("Termin nije u dobrom opsegu.");
    alert("Uneti termin nije u okviru radnog vremena, molim vas nase radno vreme je od 09:00-18:00")
    return
    }

    // Sakupljanje usluga i cena
    var usluge = [];
    var cenaUsluga = 0;

    var uslugeSelects = document.querySelectorAll(".usluga-select");
    var selectedUslugeCount = 0; // za brojanje usluga

    console.log(uslugeSelects)
    uslugeSelects.forEach(function(select) {
        var selectedValue = select.value;
        console.log(selectedValue)
        var cena = parseFloat(select.options[select.selectedIndex].getAttribute("data-cena"));
        console.log(cena)
        if (selectedValue !== "0") {
            selectedUslugeCount++; //brojim usluge
            usluge.push({
                Usluga_naziv: select.options[select.selectedIndex].text,
                Cena: cena
            });
            cenaUsluga += cena;
        }
    });

    //provera da li postoji uneta barem jedna usluga na formi
    if (selectedUslugeCount === 0) {
    alert("Molimo vas da izaberete barem jednu uslugu.");
    return; 
    }

    var reservationData = {
        Kupac: {
            Ime: ime,
            Prezime: prezime,
            Kompanija: kompanija,
            Adresa1: adresa1,
            Adresa2: adresa2,
            Postanski_broj: postanskiBroj,
            Mesto: mesto,
            Drzava: drzava,
            Email: email,
            Potvrda_email: potvrdaEmaila
        },
        Termin: termin,
        Cena: cenaUsluga,
        Promokod: promokod,
        Stavke_rezervacije: usluge,
    };

    // Sada možete koristiti reservationData objekat za slanje na server putem AJAX-a
    console.log(reservationData); 

    // Slanje AJAX zahteva na server
   $.ajax({
        type: "POST",
        url: "http://localhost:8080/api/newreservation",
        data: JSON.stringify(reservationData),
        dataType: "json",
        contentType: "application/json",
        success: function (data, text) {
                        console.log(data)
                        alert(data)
                    },
                    error: function (request, status, error) {
                        alert(request.responseText);
                    }
    });
});



    </script>
</body>
</html>

    </script>
    
</body>
</html>